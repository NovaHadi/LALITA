<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LALITA Catalog</title>
    <link rel="icon" type="image/x-icon" href="https://lh3.googleusercontent.com/pw/AP1GczPGhK4Bsqs7ATtNxHUJDaRYq39w8kJLQ9NgoMGaXgKSHpm9-kXo7yC68x3FTU5Ip7pPXzTAd7LPcSUVLukGYOOkCmrKMvGeirpwr-a7OVRQMIBuA1yF89Kk0n6LGDH48CUuF8dqEWsXNfyuvalLVefP=w913-h913-s-no-gm?authuser=0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html {
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: #1f2937;
            overflow: hidden;
        }

        #canvas-container canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #374151;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #6b7280;
            border-radius: 4px;
        }

            .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                background: #9ca3af;
            }

        .custom-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='white'%3e%3cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 0.8rem 0.8rem;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body class="text-gray-100">

    <header class="fixed top-0 left-0 right-0 z-50 bg-gray-900 border-b border-teal-600 shadow-xl h-20 overflow-hidden flex items-center justify-center">

        <div class="absolute inset-0 bg-[url('https://lh3.googleusercontent.com/pw/AP1GczMFAUSm6aUhZomjsMJwjishUqImGPjVXAyEKwcheCmn2Fd8sfyhhu7zqZGe18xAHcSCB28qgScNaOCgdHXZAINZqGL9P0FYBom6EEZOSfORRHMYZwxIP-NpOkKINF3cbojVEoVnVMEErkoh1UTwSQtT=w913-h913-s-no-gm?authuser=0')] bg-cover bg-center opacity-90"></div>
        
        <div class="relative z-10 text-center px-4">
            <h1 id="app-title-text" class="text-xl md:text-2xl font-extrabold text-white tracking-tight leading-none shadow-black drop-shadow-md">LALITA Interactive Catalog</h1>
            <p class="text-xs text-teal-300 font-light hidden sm:block mt-1 shadow-black drop-shadow-sm">Library of Archaeological Legacies and Iconographic Treasures of Ancient Java</p>
        </div>

        <div class="absolute right-4 z-20 flex space-x-3 items-center">
            <div class="relative">
                <select id="language-select" class="custom-select w-full p-2 bg-gray-700/80 backdrop-blur border border-gray-600 text-white rounded-xl shadow-md focus:ring-teal-500 focus:border-teal-500 transition-colors pr-10 appearance-none cursor-pointer text-sm font-medium">
                    <option value="id" selected>ðŸ‡®ðŸ‡© Bahasa</option>
                    <option value="en">ðŸ‡¬ðŸ‡§ English</option>
                </select>
            </div>
            <button id="login-button" class="bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 px-4 rounded-xl shadow-md transition-all duration-200 text-sm whitespace-nowrap">
                login
            </button>
        </div>
    </header>

    <div class="flex h-screen pt-20">
        <div id="sidebar" class="w-1/4 h-full bg-gray-900 border-r border-gray-700 p-6 overflow-y-auto custom-scrollbar shadow-2xl">
            <h2 class="text-2xl font-extrabold text-teal-400 mb-6 border-b border-teal-600 pb-2" id="sidebar-title">ðŸ“‚ Daftar Model</h2>
            <p class="text-sm font-semibold text-gray-400 mb-3 uppercase tracking-wider" id="files-found-label">File Ditemukan:</p>
            <ul id="file-list" class="space-y-2">
                <li class="text-gray-500 text-sm italic p-2" id="file-list-placeholder" data-status="loading">Mengambil data dari Dataverse...</li>
            </ul>
        </div>

        <div id="main-content" class="w-3/4 h-full overflow-y-auto custom-scrollbar">
            <div class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">

                <div class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 bg-gray-800 border border-gray-700 rounded-xl p-5 shadow-lg mt-4">
                    <div>
                        <label for="view-mode-select" class="block text-sm font-bold text-teal-400 mb-2" id="view-mode-label">Pilih Mode Tampilan</label>
                        <select id="view-mode-select" class="w-full p-3 bg-gray-700 border border-gray-600 text-white rounded-xl shadow-md focus:ring-teal-500 focus:border-teal-500 transition-colors">
                            <option value="detail" id="opt-detail" selected>Detail (Warna Normal)</option>
                            <option value="shaded" id="opt-shaded">Shaded (Pencahayaan)</option>
                            <option value="original" id="opt-original">Original (Tekstur/MTL)</option>
                        </select>
                    </div>
                    <div>
                        <label for="wireframe-select" class="block text-sm font-bold text-teal-400 mb-2" id="mesh-view-label">Tampilan Mesh</label>
                        <select id="wireframe-select" class="w-full p-3 bg-gray-700 border border-gray-600 text-white rounded-xl shadow-md focus:ring-teal-500 focus:border-teal-500 transition-colors">
                            <option value="solid" id="opt-solid" selected>Permukaan Padat</option>
                            <option value="wireframe" id="opt-wireframe">Tampilkan Wireframe</option>
                        </select>
                    </div>
                </div>

                <p id="view-status-message" class="text-sm text-center text-red-400 mb-4 h-5 font-semibold"></p>

                <div id="canvas-container" class="w-full h-[60vh] bg-gray-900 rounded-2xl shadow-3xl border border-gray-700 overflow-hidden mb-8 transform hover:shadow-teal-500/30 transition-shadow duration-300 relative">
                    <div id="loading-overlay" class="hidden absolute inset-0 bg-gray-900/80 z-20 flex items-center justify-center">
                        <div class="text-teal-400 font-bold animate-pulse text-xl">Loading Model...</div>
                    </div>
                </div>

                <div>
                    <h2 class="text-2xl font-bold text-white mb-3 border-b border-gray-700 pb-2" id="detail-header">ðŸ“Š Detail Objek</h2>
                    <div class="bg-gray-800 border border-gray-700 rounded-xl p-5 shadow-inner">
                        <pre id="object-description" class="text-gray-300 text-sm whitespace-pre-wrap font-mono leading-relaxed">Silakan muat file .obj dari daftar di kiri.</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
        import { MTLLoader } from 'three/addons/loaders/MTLLoader.js';

        // --- KONFIGURASI DATAVERSE ---
        const API_KEY = '5a454a48-7efd-45b9-a080-33d0b9cc44c1';
        const BASE_URL = 'https://data.brin.go.id';
        const DATASET_PID = 'hdl:20.500.12690/RIN/FRQUET';

        // --- GLOBAL UI STRINGS ---
        const UI_STRINGS = {
            id: {
                appTitle: "LALITA Interactive Catalog",
                loginButton: "Akses Data",
                sidebarTitle: "ðŸ“‚ Daftar Model",
                filesFoundLabel: "File Ditemukan:",
                fileListPlaceholder: "Mengambil data dari Server...",
                viewModeLabel: "Pilih Mode Tampilan",
                optDetail: "Detail (Warna Normal)",
                optShaded: "Shaded (Pencahayaan)",
                optOriginal: "Original (Tekstur/MTL)",
                meshViewLabel: "Tampilan Mesh",
                optSolid: "Permukaan Padat",
                optWireframe: "Tampilkan Wireframe",
                detailHeader: "ðŸ“Š Detail Objek",
                descPlaceholder: "Silakan muat file .obj dari daftar di kiri.",
                repoLoading: "Mengambil daftar file dari Dataverse RIN...",
                repoError: (err) => `Error Koneksi: ${err}. Pastikan kunci API valid.`,
                repoNoFiles: "Tidak ada file .obj ditemukan di dataset ini.",
                loading: (fileName) => `Memuat "${fileName}"...`,
                loadingText: (fileName) => `Memuat data teks "${fileName}"...`,
                loadingMtl: (fileName) => `Memuat material "${fileName}"...`,
                loadingTexture: (fileName) => `Memuat tekstur "${fileName}"...`,
                errorReadTxt: (fileName) => `[Peringatan: Gagal membaca file teks: ${fileName}]`,
                errorLoadObj: (fileName) => `Error: Gagal memuat file ${fileName}.`,
                noModelLoaded: "Tidak ada model yang dimuat.",
                detailModeApplied: "Mode: Detail (Normal) diterapkan.",
                shadedModeApplied: "Mode: Shaded (Lit) diterapkan.",
                originalTextureApplied: "Mode: Original (Tekstur Kustom) diterapkan.",
                originalMtlApplied: "Mode: Original (MTL) berhasil diterapkan.",
                warningNoMtlTex: "PERINGATAN: File MTL/Tekstur tidak ditemukan. Kembali ke mode Shaded.",
                fieldName: "Nama File",
                fieldMeshes: "Jumlah Mesh",
                fieldVertices: "Total Vertex",
                fieldTriangles: "Total Segitiga",
                fieldMtlLoaded: "Data MTL",
                fieldTexLoaded: "Data Tekstur",
                statusYesMtl: "Ya (Dimuat)",
                statusNoMtl: "Tidak (Default)",
                statusYesTex: "Ya (Dimuat)",
                statusNoTex: "Tidak (Default)",
                indicatorNoTxt: "(No Info)",
                indicatorNoMtl: "(No MTL)",
                indicatorNoTex: "(No TEX)"
            },
            en: {
                appTitle: "LALITA Interactive Catalog",
                loginButton: "Access Data",
                sidebarTitle: "ðŸ“‚ Model List",
                filesFoundLabel: "Files Found:",
                fileListPlaceholder: "Fetching data from Server...",
                viewModeLabel: "Select View Mode",
                optDetail: "Detail (Normal Color)",
                optShaded: "Shaded (Lit)",
                optOriginal: "Original (Texture/MTL)",
                meshViewLabel: "Mesh View",
                optSolid: "Solid Surface",
                optWireframe: "Show Wireframe",
                detailHeader: "ðŸ“Š Object Details",
                descPlaceholder: "Please load an .obj file from the list on the left.",
                repoLoading: "Fetching file list from RIN Dataverse...",
                repoError: (err) => `Connection Error: ${err}. Check API Key.`,
                repoNoFiles: "No .obj files found in this dataset.",
                loading: (fileName) => `Loading "${fileName}"...`,
                loadingText: (fileName) => `Loading text data "${fileName}"...`,
                loadingMtl: (fileName) => `Loading materials "${fileName}"...`,
                loadingTexture: (fileName) => `Loading texture "${fileName}"...`,
                errorReadTxt: (fileName) => `[Warning: Failed to read text file: ${fileName}]`,
                errorLoadObj: (fileName) => `Error: Failed to load file ${fileName}.`,
                noModelLoaded: "No model is currently loaded.",
                detailModeApplied: "Mode: Detail (Normal) applied.",
                shadedModeApplied: "Mode: Shaded (Lit) applied.",
                originalTextureApplied: "Mode: Original (Custom Texture) applied.",
                originalMtlApplied: "Mode: Original (MTL) successfully applied.",
                warningNoMtlTex: "INFO: MTL/Texture file unavailable. Using Shaded mode.",
                fieldName: "File Name",
                fieldMeshes: "Meshes",
                fieldVertices: "Total Vertices",
                fieldTriangles: "Total Triangles",
                fieldMtlLoaded: "MTL Data",
                fieldTexLoaded: "Texture Data",
                statusYesMtl: "Yes (Loaded)",
                statusNoMtl: "No",
                statusYesTex: "Yes (Loaded)",
                statusNoTex: "No",
                indicatorNoTxt: "(No Info)",
                indicatorNoMtl: "(No MTL)",
                indicatorNoTex: "(No TEX)"
            }
        };

        // --- GLOBAL VARIABLES ---
        let currentLang = 'id';
        let scene, camera, renderer, controls, loadedObject;
        let ambientLight, directionalLight;

        // DOM Elements
        const canvasContainer = document.getElementById('canvas-container');
        const descriptionEl = document.getElementById('object-description');
        const fileListEl = document.getElementById('file-list');
        const viewStatusMessageEl = document.getElementById('view-status-message');
        const languageSelect = document.getElementById('language-select');
        const fileListPlaceholderEl = document.getElementById('file-list-placeholder');
        const loadingOverlay = document.getElementById('loading-overlay');
        const viewModeSelect = document.getElementById('view-mode-select');
        const wireframeSelect = document.getElementById('wireframe-select');

        let loadedFileObjects = new Map();

        // Materials
        let originalMaterials = null;
        let customTexture = null;
        let customTexturedMaterial = null;
        let isWireframe = false;

        const normalMaterial = new THREE.MeshNormalMaterial();
        const shadedMaterial = new THREE.MeshStandardMaterial({
            color: 0x86efac,
            roughness: 0.7,
            metalness: 0.1
        });

        // --- INITIALIZATION ---
        async function init() {
            updateUI(languageSelect.value);

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xffffff);

            camera = new THREE.PerspectiveCamera(75, 2, 0.1, 1000);
            camera.position.set(10, 10, 10);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            canvasContainer.appendChild(renderer.domElement);
            onWindowResize();

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            // Lighting
            ambientLight = new THREE.AmbientLight(0xffffff, 0.9);
            scene.add(ambientLight);

            directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
            directionalLight.position.set(10, 15, 10);
            directionalLight.visible = false;
            scene.add(directionalLight);

            //const gridHelper = new THREE.GridHelper(100, 100, 0x4b5563, 0x374151);
            //scene.add(gridHelper);

            // Listeners
            window.addEventListener('resize', onWindowResize);
            languageSelect.addEventListener('change', (e) => updateUI(e.target.value));

            viewModeSelect.addEventListener('change', () => updateObjectMaterial(true));
            wireframeSelect.addEventListener('change', () => updateObjectMaterial(true));

            fileListEl.addEventListener('click', (event) => {
                const button = event.target.closest('.file-item-button');
                const fileKey = button?.dataset.fileKey;
                if (!fileKey) return;

                const filePairToLoad = loadedFileObjects.get(fileKey);
                if (filePairToLoad && filePairToLoad.objFile) {
                    document.querySelectorAll('.file-item-button').forEach(btn => btn.disabled = true);
                    loadingOverlay.classList.remove('hidden');

                    loadObjectAndDescription(filePairToLoad.objFile, filePairToLoad.txtFile, filePairToLoad.mtlFile, filePairToLoad.texFile)
                        .catch(err => {
                            console.error("Load Error:", err);
                            const strings = UI_STRINGS[currentLang];
                            updateDescription(null, null, null, strings.errorLoadObj(filePairToLoad.objFile.filename));
                        })
                        .finally(() => {
                            document.querySelectorAll('.file-item-button').forEach(btn => btn.disabled = false);
                            loadingOverlay.classList.add('hidden');
                        });
                }
            });

            animate();
            loadDataverseFiles();
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            const width = canvasContainer.clientWidth;
            const height = canvasContainer.clientHeight;
            if (width === 0 || height === 0) return;
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }

        function displayStatusMessage(message, type = 'info', duration = 3000) {
            if (window.statusTimeout) clearTimeout(window.statusTimeout);
            viewStatusMessageEl.textContent = message;
            viewStatusMessageEl.className = 'text-sm text-center mb-4 h-5 font-semibold transition-all duration-300';
            if (type === 'warn') viewStatusMessageEl.classList.add('text-orange-400');
            else viewStatusMessageEl.classList.add('text-teal-400');

            if (duration > 0) {
                window.statusTimeout = setTimeout(() => {
                    viewStatusMessageEl.textContent = '';
                }, duration);
            }
        }

        // --- UI FUNCTIONS ---
        function updateUI(lang) {
            currentLang = lang;
            const strings = UI_STRINGS[lang];

            document.getElementById('app-title-text').textContent = strings.appTitle;
            document.getElementById('login-button').textContent = strings.loginButton;
            document.getElementById('sidebar-title').textContent = strings.sidebarTitle;
            document.getElementById('files-found-label').textContent = strings.filesFoundLabel;

            if (fileListPlaceholderEl) {
                const status = fileListPlaceholderEl.dataset.status;
                if (status === 'loading') fileListPlaceholderEl.textContent = strings.repoLoading;
                else if (status === 'empty') fileListPlaceholderEl.textContent = strings.repoNoFiles;
                else if (status === 'placeholder') fileListPlaceholderEl.textContent = strings.descPlaceholder;
            }

            document.getElementById('view-mode-label').textContent = strings.viewModeLabel;
            document.getElementById('opt-detail').textContent = strings.optDetail;
            document.getElementById('opt-shaded').textContent = strings.optShaded;
            document.getElementById('opt-original').textContent = strings.optOriginal;
            document.getElementById('mesh-view-label').textContent = strings.meshViewLabel;
            document.getElementById('opt-solid').textContent = strings.optSolid;
            document.getElementById('opt-wireframe').textContent = strings.optWireframe;
            document.getElementById('detail-header').textContent = strings.detailHeader;

            if (!loadedObject) {
                descriptionEl.textContent = strings.descPlaceholder;
            } else {
                updateDescription(loadedObject, loadedObject.name, loadedObject.descriptionText, null, loadedObject.textureDataURL);
            }
            if (loadedFileObjects.size > 0) renderFileList();
        }

        // --- DATA FETCHING (DATAVERSE) ---
        async function loadDataverseFiles() {
            const strings = UI_STRINGS[currentLang];
            fileListPlaceholderEl.textContent = strings.repoLoading;
            fileListPlaceholderEl.dataset.status = 'loading';

            try {
                const endpoint = `${BASE_URL}/api/datasets/:persistentId/versions/:latest/files?persistentId=${DATASET_PID}`;
                const response = await fetch(endpoint, { headers: { 'X-Dataverse-Key': API_KEY } });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const json = await response.json();

                if (!json.data || json.data.length === 0) {
                    fileListPlaceholderEl.textContent = strings.repoNoFiles;
                    fileListPlaceholderEl.dataset.status = 'empty';
                    return;
                }

                const fileMap = new Map();

                json.data.forEach(item => {
                    const file = item.dataFile;
                    const filename = file.filename;
                    const lastDotIndex = filename.lastIndexOf('.');
                    if (lastDotIndex === -1) return;

                    const ext = filename.substring(lastDotIndex + 1).toLowerCase();
                    const baseName = filename.substring(0, lastDotIndex);

                    if (!fileMap.has(baseName)) fileMap.set(baseName, { objFile: null, txtFile: null, mtlFile: null, texFile: null });
                    const entry = fileMap.get(baseName);
                    const fileData = { id: file.id, filename: filename, contentType: file.contentType };

                    if (ext === 'obj') entry.objFile = fileData;
                    else if (ext === 'txt') entry.txtFile = fileData;
                    else if (ext === 'mtl') entry.mtlFile = fileData;
                    else if (['jpg', 'jpeg', 'png'].includes(ext)) entry.texFile = fileData;
                });

                loadedFileObjects.clear();
                fileMap.forEach((val, key) => {
                    if (val.objFile) loadedFileObjects.set(key, val);
                });

                if (loadedFileObjects.size === 0) {
                    fileListPlaceholderEl.textContent = strings.repoNoFiles;
                    fileListPlaceholderEl.dataset.status = 'empty';
                } else {
                    renderFileList();
                }
                updateUI(currentLang);

            } catch (err) {
                console.error("Dataverse Error:", err);
                fileListPlaceholderEl.textContent = strings.repoError(err.message);
                fileListPlaceholderEl.classList.add("text-red-500");
                fileListPlaceholderEl.dataset.status = 'error';
            }
        }

        function renderFileList() {
            const strings = UI_STRINGS[currentLang];
            fileListEl.innerHTML = '';

            if (loadedFileObjects.size === 0) {
                fileListEl.appendChild(fileListPlaceholderEl);
                return;
            }
            if (fileListPlaceholderEl && fileListPlaceholderEl.parentNode) fileListPlaceholderEl.remove();

            const objKeys = Array.from(loadedFileObjects.keys()).sort((a, b) => a.localeCompare(b));

            objKeys.forEach(key => {
                const li = document.createElement('li');
                const button = document.createElement('button');
                button.className = "file-item-button w-full text-left p-3 rounded-lg bg-gray-800 hover:bg-teal-700 transition-colors duration-200 text-sm font-medium disabled:opacity-50 shadow-md";
                button.dataset.fileKey = key;

                const filePair = loadedFileObjects.get(key);
                let indicator = '';
                if (!filePair.txtFile) indicator += ` <span class="text-orange-400 text-xs font-bold">${strings.indicatorNoTxt}</span>`;
                if (!filePair.mtlFile) indicator += ` <span class="text-sky-400 text-xs font-bold">${strings.indicatorNoMtl}</span>`;
                if (!filePair.texFile) indicator += ` <span class="text-yellow-400 text-xs font-bold">${strings.indicatorNoTex}</span>`;

                button.innerHTML = key + indicator;
                li.appendChild(button);
                fileListEl.appendChild(li);
            });
        }

        async function fetchDataverseFileContent(fileId, responseType = 'text') {
            const url = `${BASE_URL}/api/access/datafile/${fileId}`;
            const response = await fetch(url, { headers: { 'X-Dataverse-Key': API_KEY } });
            if (!response.ok) throw new Error(`Failed to fetch file. Status: ${response.status}`);
            return responseType === 'arraybuffer' ? response.arrayBuffer() : response.text();
        }

        // --- LOADING & PARSING LOGIC ---
        async function loadObjectAndDescription(objFile, txtFile = null, mtlFile = null, texFile = null) {
            const strings = UI_STRINGS[currentLang];
            const fileName = objFile.filename;
            displayStatusMessage(strings.loading(fileName), 'info', 0);

            // Cleanup
            if (loadedObject) {
                scene.remove(loadedObject);
                loadedObject.traverse(child => {
                    if (child.isMesh) {
                        child.geometry.dispose();
                        if (Array.isArray(child.material)) child.material.forEach(m => { if (m.map) m.map.dispose(); m.dispose(); });
                        else { if (child.material.map) child.material.map.dispose(); child.material.dispose(); }
                    }
                });
            }
            if (customTexture) customTexture.dispose();
            loadedObject = null;
            originalMaterials = null;
            customTexture = null;
            customTexturedMaterial = null;

            // 1. Fetch OBJ Content
            const objContent = await fetchDataverseFileContent(objFile.id, 'text');

            // 2. Fetch Description
            let descriptionText = strings.descPlaceholder;
            if (txtFile) {
                try {
                    displayStatusMessage(strings.loadingText(fileName), 'info', 0);
                    descriptionText = await fetchDataverseFileContent(txtFile.id, 'text');
                } catch (e) { descriptionText = strings.errorReadTxt(txtFile.filename); }
            }

            // 3. Fetch MTL
            if (mtlFile) {
                try {
                    displayStatusMessage(strings.loadingMtl(fileName), 'info', 0);
                    const mtlContent = await fetchDataverseFileContent(mtlFile.id, 'text');
                    const mtlLoader = new MTLLoader();
                    originalMaterials = mtlLoader.parse(mtlContent);
                    originalMaterials.preload();
                } catch (e) { console.warn("MTL Error", e); }
            }

            // 4. Fetch Texture & Create Material
            let textureDataURL = null;
            if (texFile) {
                try {
                    displayStatusMessage(strings.loadingTexture(fileName), 'info', 0);
                    const arrayBuffer = await fetchDataverseFileContent(texFile.id, 'arraybuffer');
                    const mimeType = texFile.contentType || (texFile.filename.toLowerCase().endsWith('.png') ? 'image/png' : 'image/jpeg');
                    const blob = new Blob([arrayBuffer], { type: mimeType });
                    textureDataURL = URL.createObjectURL(blob);

                    await new Promise((resolve, reject) => {
                        const texLoader = new THREE.TextureLoader();
                        customTexture = texLoader.load(
                            textureDataURL,
                            (tex) => {
                                tex.colorSpace = THREE.SRGBColorSpace;
                                tex.wrapS = THREE.RepeatWrapping;
                                tex.wrapT = THREE.RepeatWrapping;
                                customTexturedMaterial = new THREE.MeshStandardMaterial({
                                    map: tex,
                                    color: 0xffffff,
                                    roughness: 0.6,
                                    metalness: 0.1,
                                    side: THREE.DoubleSide
                                });
                                resolve();
                            },
                            undefined,
                            (err) => { console.warn(err); resolve(); }
                        );
                    });
                } catch (e) { console.warn("Tex Error", e); }
            }

            // 5. Parse OBJ
            displayStatusMessage(strings.loading(fileName), 'info', 0);
            const loader = new OBJLoader();

            if (originalMaterials && !customTexturedMaterial) {
                loader.setMaterials(originalMaterials);
            }

            loadedObject = loader.parse(objContent);

            // Centering
            const box = new THREE.Box3().setFromObject(loadedObject);
            const size = box.getSize(new THREE.Vector3());
            const center = box.getCenter(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            const scaleFactor = 8 / maxDim;

            loadedObject.position.set(-center.x * scaleFactor, -center.y * scaleFactor, -center.z * scaleFactor);
            loadedObject.scale.set(scaleFactor, scaleFactor, scaleFactor);

            // Simpan Material Original
            loadedObject.traverse((child) => {
                if (child.isMesh) {
                    if (customTexturedMaterial) {
                        child.originalMaterial = customTexturedMaterial;
                    } else if (originalMaterials) {
                        child.originalMaterial = child.material;
                    } else {
                        child.originalMaterial = shadedMaterial.clone();
                    }
                }
            });

            scene.add(loadedObject);
            loadedObject.name = fileName;
            loadedObject.descriptionText = descriptionText;
            loadedObject.textureDataURL = textureDataURL;

            // Reset UI
            viewModeSelect.value = 'detail';
            wireframeSelect.value = 'solid';

            updateObjectMaterial(true);
            updateDescription(loadedObject, fileName, descriptionText, null, textureDataURL);
        }

        // --- UPDATE MATERIAL FUNCTION ---
        function updateObjectMaterial(forceStatusUpdate = false) {
            const strings = UI_STRINGS[currentLang];

            if (!loadedObject) return;

            const baseStyle = viewModeSelect.value;
            const wireframeStyle = wireframeSelect.value;
            isWireframe = (wireframeStyle === 'wireframe');

            let targetMaterial = null;

            if (baseStyle === 'detail') {
                targetMaterial = normalMaterial;
                directionalLight.visible = false;
                if (forceStatusUpdate) displayStatusMessage(strings.detailModeApplied, 'info', 2000);

            } else if (baseStyle === 'shaded') {
                targetMaterial = shadedMaterial;
                directionalLight.visible = true;
                if (forceStatusUpdate) displayStatusMessage(strings.shadedModeApplied, 'info', 2000);

            } else if (baseStyle === 'original') {
                directionalLight.visible = true;

                if (customTexturedMaterial) {
                    if (forceStatusUpdate) displayStatusMessage(strings.originalTextureApplied, 'info');
                } else if (originalMaterials) {
                    if (forceStatusUpdate) displayStatusMessage(strings.originalMtlApplied, 'info');
                } else {
                    console.warn("No MTL/Texture. Fallback to Shaded.");
                    viewModeSelect.value = 'shaded';
                    targetMaterial = shadedMaterial;
                    if (forceStatusUpdate) displayStatusMessage(strings.warningNoMtlTex, 'warn');
                }
            }

            loadedObject.traverse((child) => {
                if (child.isMesh) {
                    if (baseStyle === 'original' && (customTexturedMaterial || originalMaterials)) {
                        child.material = child.originalMaterial;

                        const materialsToUpdate = Array.isArray(child.material) ? child.material : [child.material];
                        materialsToUpdate.forEach(m => {
                            if (m) {
                                m.wireframe = isWireframe;
                                m.needsUpdate = true;
                            }
                        });

                    } else if (targetMaterial) {
                        child.material = targetMaterial;
                        targetMaterial.wireframe = isWireframe;
                        targetMaterial.needsUpdate = true;
                    }
                }
            });
        }

        function updateDescription(obj, fileName, descriptionText, errorMsg = null, textureDataURL = null) {
            const strings = UI_STRINGS[currentLang];

            if (errorMsg) {
                descriptionEl.textContent = `*** ERROR ***\n\n${errorMsg}`;
                descriptionEl.classList.add('text-red-400');
                return;
            }

            if (!obj) {
                descriptionEl.textContent = strings.descPlaceholder;
                descriptionEl.classList.remove('text-red-400');
                descriptionEl.classList.add('text-gray-300');
                return;
            }

            descriptionEl.classList.remove('text-red-400');
            descriptionEl.classList.add('text-gray-300');

            let meshCount = 0, vertexCount = 0, faceCount = 0;
            obj.traverse(function (child) {
                if (child.isMesh) {
                    meshCount++;
                    const geo = child.geometry;
                    if (geo.attributes.position) vertexCount += geo.attributes.position.count;
                    if (geo.index) faceCount += geo.index.count / 3;
                    else if (geo.attributes.position) faceCount += geo.attributes.position.count / 3;
                }
            });

            const mtlStatus = originalMaterials ? (strings.statusYesMtl) : (strings.statusNoMtl);
            const texStatus = textureDataURL ? (strings.statusYesTex) : (strings.statusNoTex);

            let stats = `\
${strings.fieldName}:        ${fileName}
${strings.fieldMeshes}:           ${meshCount}
${strings.fieldVertices}:   ${vertexCount.toLocaleString()}
${strings.fieldTriangles}:  ${Math.round(faceCount).toLocaleString()}
${strings.fieldMtlLoaded}:  ${mtlStatus}
${strings.fieldTexLoaded}:   ${texStatus}
---
`;
            if (descriptionText && descriptionText !== strings.descPlaceholder) {
                stats += `\n${descriptionText}\n`;
            }
            descriptionEl.textContent = stats.trim();
        }

        window.onload = init;
    </script>
</body>
</html>
