<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Catalog (Google Drive)</title>
    <link rel="icon" type="image/x-icon" href="https://lh3.googleusercontent.com/pw/AP1GczPGhK4Bsqs7ATtNxHUJDaRYq39w8kJLQ9NgoMGaXgKSHpm9-kXo7yC68x3FTU5Ip7pPXzTAd7LPcSUVLukGYOOkCmrKMvGeirpwr-a7OVRQMIBuA1yF89Kk0n6LGDH48CUuF8dqEWsXNfyuvalLVefP=w913-h913-s-no-gm?authuser=0">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google API Client Library -->
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        /* Set a smooth dark theme with the Inter font */
        html {
            font-family: 'Inter', sans-serif;
        }
        body {
            /* Smooth dark background */
            background-color: #1f2937; /* Gray-800 */
            overflow: hidden; 
        }
        /* Ensure the canvas fills its container */
        #canvas-container canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        /* Custom scrollbar styling (optional, but nice) */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #374151; /* Gray-700 */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #6b7280; /* Gray-500 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af; /* Gray-400 */
        }
        /* Style untuk dropdown bahasa */
        .custom-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='https://lh3.googleusercontent.com/pw/AP1GczNU9h-gStbAwFSMjY2buNb0Y75LYNAAx8bWld3HD0ndFZ5aX_46_q0n9aszU0DW-dBrXYy8C60dQfemcbXH63Yq2IdSLCZTs2Nb8kT_F63f5c0vfDTIAdK8C7vWSy-HhpbsigSZzJ4ka_KMci-gJkIV=w913-h913-s-no-gm?authuser=0' viewBox='0 0 20 20' fill='white'%3e%3cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 0.8rem 0.8rem;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>
</head>
<body class="text-gray-100">
    
    <header id="fixed-top-bar" class="fixed top-0 left-0 right-0 z-50 bg-gray-900/95 backdrop-blur-sm border-b border-teal-600 shadow-xl p-3 flex justify-between items-center transition-all duration-300">
        
        <div class="flex items-center space-x-3">
            <img 
                src="https://lh3.googleusercontent.com/pw/AP1GczOY8wBgYwKIgw1IyC33cSInSjXZD8NdhN6esC7V3VJeEFP0RAS5eoB4jW3tdETF7gwqf-F156o9ANqIs1QWsFRIk34xWwkb510o3iQKhvXc7ZJgG0ClaA7tkjO4XKIZfC3QX9Ml846yPgyoHEqaT4t7=w913-h913-s-no-gm?authuser=0" 
                alt="Interactive Catalog Logo" 
                class="h-14 w-14 rounded-xl shadow-md border-0 border-teal-500 object-contain"
            > 
            <h1 id="app-title-text" class="text-xl font-extrabold text-white-400 hidden sm:block tracking-wider">INTERACTIVE CATALOG</h1>
        </div>
        
        <div class="flex space-x-3 items-center">
            
            <div class="relative">
                <select id="language-select" class="custom-select w-full p-2 bg-gray-700 border border-gray-600 text-white rounded-xl shadow-md focus:ring-teal-500 focus:border-teal-500 transition-colors pr-10 appearance-none cursor-pointer text-sm font-medium">
                    <option value="id" selected>ðŸ‡®ðŸ‡© Bahasa</option>
                    <option value="en">ðŸ‡¬ðŸ‡§ English</option>
                </select>
                </div>
            
            <button id="login-button" class="bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 px-4 rounded-xl shadow-md transition-all duration-200 text-sm transform hover:scale-[1.05]">
                Masuk / Daftar
            </button>
        </div>
    </header>


    <div class="flex h-screen pt-16"> 

        <div id="sidebar" class="w-1/4 h-full bg-gray-900 border-r border-gray-700 p-6 overflow-y-auto custom-scrollbar shadow-2xl">
            <h2 class="text-2xl font-extrabold text-teal-400 mb-6 border-b border-teal-600 pb-2" id="sidebar-title">ðŸ“‚ Daftar Model</h2>
            
            <!-- Tombol folder-picker-button dan input folder-input dihapus -->

            <p class="text-sm font-semibold text-gray-400 mb-3 uppercase tracking-wider" id="files-found-label">File Ditemukan:</p>
            
            <ul id="file-list" class="space-y-2">
                <li class="text-gray-500 text-sm italic p-2" id="file-list-placeholder">Mengambil data dari Google Drive...</li>
            </ul>
        </div>

        <div id="main-content" class="w-3/4 h-full overflow-y-auto custom-scrollbar">
            <div class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
                
                <header class="relative mb-8 p-8 bg-gradient-to-r from-gray-700 to-gray-900 rounded-2xl shadow-2xl overflow-hidden">
                    <div class="absolute inset-0 bg-[url('https://lh3.googleusercontent.com/pw/AP1GczMFAUSm6aUhZomjsMJwjishUqImGPjVXAyEKwcheCmn2Fd8sfyhhu7zqZGe18xAHcSCB28qgScNaOCgdHXZAINZqGL9P0FYBom6EEZOSfORRHMYZwxIP-NpOkKINF3cbojVEoVnVMEErkoh1UTwSQtT=w913-h913-s-no-gm?authuser=0')] bg-cover bg-center"></div>
                    <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-transparent to-transparent"></div>
                    
                    <div class="relative z-10 text-center">
                        <h1 class="text-5xl font-extrabold text-white tracking-tight" id="main-header-title">LALITA Interactive Catalog </h1>
                        <p class="text-xl text-teal-300 mt-2 font-light" id="main-header-subtitle">Library of Archaeological Legacies and Iconographic Treasures of Ancient Java</p>
                    </div>
                </header>

/*                <div class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 bg-gray-800 border border-gray-700 rounded-xl p-5 shadow-lg">
                    <div>
                        <label for="view-mode-select" class="block text-sm font-bold text-teal-400 mb-2" id="view-mode-label">Pilih Mode Tampilan</label>
                        <select id="view-mode-select" class="w-full p-3 pr-10 bg-gray-700 border border-gray-600 text-white rounded-xl shadow-md focus:ring-teal-500 focus:border-teal-500 transition-colors custom-select appearance-none">
                            <option value="detail" id="opt-detail" selected>Detail (Warna Normal)</option>
                            <option value="shaded" id="opt-shaded">Shaded (Pencahayaan)</option>
                            <option value="original" id="opt-original">Original (Tekstur/MTL)</option>
                        </select>
                    </div>
                    <div>
                        <label for="wireframe-select" class="block text-sm font-bold text-teal-400 mb-2" id="mesh-view-label">Tampilan Mesh</label>
                        <select id="wireframe-select" class="w-full p-3 pr-10 bg-gray-700 border border-gray-600 text-white rounded-xl shadow-md focus:ring-teal-500 focus:border-teal-500 transition-colors custom-select appearance-none">
                            <option value="solid" id="opt-solid" selected>Permukaan Padat</option>
                            <option value="wireframe" id="opt-wireframe">Tampilkan Wireframe</option>
                        </select>
                    </div>
                </div>
*/
                <div class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 bg-gray-800 border border-gray-700 rounded-xl p-5 shadow-lg">
                    <div>
                        <label for="view-mode-select" class="block text-sm font-bold text-teal-400 mb-2" id="view-mode-label">Pilih Mode Tampilan</label>
                        
                        <select id="view-mode-select" class="custom-select appearance-none cursor-pointer w-full p-3 pr-10 bg-gray-700 border border-gray-600 text-white rounded-xl shadow-md focus:ring-teal-500 focus:border-teal-500 transition-colors">
                            <option value="detail" id="opt-detail" selected>Detail (Warna Normal)</option>
                            <option value="shaded" id="opt-shaded">Shaded (Pencahayaan)</option>
                            <option value="original" id="opt-original">Original (Tekstur/MTL)</option>
                        </select>
                    </div>
                    <div>
                        <label for="wireframe-select" class="block text-sm font-bold text-teal-400 mb-2" id="mesh-view-label">Tampilan Mesh</label>
                        
                        <select id="wireframe-select" class="custom-select appearance-none cursor-pointer w-full p-3 pr-10 bg-gray-700 border border-gray-600 text-white rounded-xl shadow-md focus:ring-teal-500 focus:border-teal-500 transition-colors">
                            <option value="solid" id="opt-solid" selected>Permukaan Padat</option>
                            <option value="wireframe" id="opt-wireframe">Tampilkan Wireframe</option>
                        </select>
                    </div>
                </div>
                
                <p id="view-status-message" class="text-sm text-center text-red-400 mb-4 h-5 font-semibold"></p>

                <div id="canvas-container" class="w-full h-[60vh] bg-gray-900 rounded-2xl shadow-3xl border border-gray-700 overflow-hidden mb-8 transform hover:shadow-teal-500/30 transition-shadow duration-300">
                    </div>

                <div>
                    <h2 class="text-2xl font-bold text-white mb-3 border-b border-gray-700 pb-2" id="detail-header">ðŸ“Š Detail Objek</h2>
                    <div class="bg-gray-800 border border-gray-700 rounded-xl p-5 shadow-inner">
                        <pre id="object-description" class="text-gray-300 text-sm whitespace-pre-wrap font-mono leading-relaxed">
Silakan muat file .obj dari daftar di kiri.
                        </pre>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // Import all necessary modules from the import map
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
        import { MTLLoader } from 'three/addons/loaders/MTLLoader.js'; 

        // --- KONFIGURASI GOOGLE DRIVE ---
        // !!! PENTING: Ganti dengan API Key Anda !!!
        const API_KEY = 'AIzaSyBxGawynVXWOkPliGbuG9blk8kO73cfF8I'; 
        // ID Folder Google Drive yang akan di-load
        const FOLDER_ID = '1LiuZZW-UbjBj1DPHrJV3PsF7pjKAgmiY';


        // --- GLOBAL UI STRINGS (Multilingual Support) ---
        const UI_STRINGS = {
            id: {
                appTitle: "INTERACTIVE CATALOG",
                loginButton: "Masuk / Daftar",
                sidebarTitle: "ðŸ“‚ Daftar Model", // Diubah
                folderButton: "Pilih Folder Model...",
                filesFoundLabel: "File Ditemukan:",
                fileListPlaceholder: "Pilih folder untuk memuat file .obj.",
                // Status Google Drive
                gdriveLoading: "Mengambil data dari Google Drive...",
                gdriveError: (err) => `Error Google Drive: ${err.message}. Pastikan API Key valid dan folder dapat diakses.`,
                gdriveNoFiles: "Tidak ada file .obj ditemukan di folder Google Drive.",
                // Status Messages
                loading: (fileName) => `Memuat "${fileName}"...`,
                loadingText: (fileName) => `Memuat "${fileName}" dan teks pendamping...`,
                loadingMtl: (fileName) => `Memuat "${fileName}" dan material...`,
                loadingTexture: (fileName) => `Memuat "${fileName}" dan tekstur...`,
                errorReadTxt: (fileName) => `[Peringatan: Gagal memuat file TXT pendamping: ${fileName}]`,
                errorLoadTxt: (fileName) => `[Peringatan: Terjadi kesalahan saat memuat file TXT pendamping: ${fileName}]`,
                errorLoadObj: (fileName) => `Error: Gagal memuat file ${fileName}.`,
                errorFetch: (fileName, status) => `Error: Gagal mengambil file ${fileName} dari Google Drive. Status: ${status}`,
                errorParseObj: "Error: Gagal memuat atau parse .obj file. Periksa konsol untuk detail.",
                noModelLoaded: "Tidak ada model yang dimuat.",
                detailModeApplied: "Mode Tampilan: Detail (Normal) diterapkan.",
                shadedModeApplied: "Mode Tampilan: Shaded (Lit) diterapkan.",
                originalTextureApplied: "Mode Tampilan: Original (Tekstur Kustom) diterapkan.",
                originalMtlApplied: "Mode Tampilan: Original (MTL) berhasil diterapkan.",
                warningNoMtlTex: "PERINGATAN: File MTL/Tekstur tidak ditemukan. Kembali ke mode Shaded.",
                // Description Fields
                fieldName: "File Name",
                fieldMeshes: "Meshes",
                fieldVertices: "Total Vertices",
                fieldTriangles: "Total Triangles",
                fieldMtlLoaded: "MTL Data Loaded",
                fieldTexLoaded: "Texture Loaded",
                statusYesMtl: "Ya (Bahan baku MTL dimuat)",
                statusNoMtl: "Tidak (Default/Tidak Ditemukan)",
                statusYesTex: "Ya (Tekstur kustom dimuat)",
                statusNoTex: "Tidak (Default/Tidak Ditemukan)",
                indicatorNoTxt: "(No TXT)",
                indicatorNoMtl: "(No MTL)",
                indicatorNoTex: "(No TEX)"
            },
            en: {
                appTitle: "INTERACTIVE CATALOG",
                loginButton: "Login / Register",
                sidebarTitle: "ðŸ“‚ Model List", // Changed
                folderButton: "Select Model Folder...",
                filesFoundLabel: "Files Found:",
                fileListPlaceholder: "Select a folder to load .obj files.",
                // Google Drive Status
                gdriveLoading: "Loading from Google Drive...",
                gdriveError: (err) => `Google Drive Error: ${err.message}. Ensure API Key is valid and folder is accessible.`,
                gdriveNoFiles: "No .obj files found in the Google Drive folder.",
                // Status Messages
                loading: (fileName) => `Loading "${fileName}"...`,
                loadingText: (fileName) => `Loading "${fileName}" and companion text...`,
                loadingMtl: (fileName) => `Loading "${fileName}" and materials...`,
                loadingTexture: (fileName) => `Loading "${fileName}" and texture...`,
                errorReadTxt: (fileName) => `[Warning: Failed to read companion TXT file: ${fileName}]`,
                errorLoadTxt: (fileName) => `[Warning: Error loading companion TXT file: ${fileName}]`,
                errorLoadObj: (fileName) => `Error: Failed to load file ${fileName}.`,
                errorFetch: (fileName, status) => `Error: Failed to fetch file ${fileName} from Google Drive. Status: ${status}`,
                errorParseObj: "Error: Failed to load or parse .obj file. Check console for details.",
                noModelLoaded: "No model is currently loaded.",
                detailModeApplied: "View Mode: Detail (Normal) applied.",
                shadedModeApplied: "View Mode: Shaded (Lit) applied.",
                originalTextureApplied: "View Mode: Original (Custom Texture) applied.",
                originalMtlApplied: "View Mode: Original (MTL) successfully applied.",
                warningNoMtlTex: "WARNING: MTL/Texture file not found. Falling back to Shaded mode.",
                // Description Fields
                fieldName: "File Name",
                fieldMeshes: "Meshes",
                fieldVertices: "Total Vertices",
                fieldTriangles: "Total Triangles",
                fieldMtlLoaded: "MTL Data Loaded",
                fieldTexLoaded: "Texture Loaded",
                statusYesMtl: "Yes (MTL materials loaded)",
                statusNoMtl: "No (Default/Not Found)",
                statusYesTex: "Yes (Custom Texture loaded)",
                statusNoTex: "No (Default/Not Found)",
                indicatorNoTxt: "(No TXT)",
                indicatorNoMtl: "(No MTL)",
                indicatorNoTex: "(No TEX)"
            }
        };

        // Current language state
        let currentLang = 'id';
        
        let scene, camera, renderer, controls, loadedObject;
        let ambientLight, directionalLight;
        const canvasContainer = document.getElementById('canvas-container');
        const descriptionEl = document.getElementById('object-description');
        const fileListEl = document.getElementById('file-list');
        const viewStatusMessageEl = document.getElementById('view-status-message');
        const languageSelect = document.getElementById('language-select');
        const fileListPlaceholderEl = document.getElementById('file-list-placeholder');

        // Map untuk menyimpan objek File Google Drive (.obj, .txt, .mtl, .tex)
        // Strukturnya: Map<string, {objFile, txtFile, mtlFile, texFile}>
        // Di mana value adalah objek dari Google Drive API {id, name, webContentLink}
        let loadedFileObjects = new Map();
        
        // Variabel global untuk menyimpan material yang dimuat
        let originalMaterials = null; 
        let customTexture = null;
        let customTexturedMaterial = null;


        // --- Materials ---
        const normalMaterial = new THREE.MeshNormalMaterial();
        const shadedMaterial = new THREE.MeshStandardMaterial({
            color: 0x86efac, // Emerald-400 for a smooth look
            roughness: 0.7,
            metalness: 0.1
        });
        let currentBaseMaterial = normalMaterial; 
        let isWireframe = false;


        // --- FUNGSI: UPDATE BAHASA UI ---
        function updateUI(lang) {
            currentLang = lang;
            const strings = UI_STRINGS[lang];

            // --- TAMBAHKAN DUA BARIS INI ---
            console.log("DEBUG: String object yang dimuat untuk bahasa '" + lang + "':");
            console.log(strings);
            // ---------------------------------
            
            // 1. Header dan Tombol
            document.getElementById('app-title-text').textContent = strings.appTitle;
            document.getElementById('login-button').textContent = strings.loginButton;

            // 2. Sidebar
            document.getElementById('sidebar-title').textContent = strings.sidebarTitle;
            document.getElementById('files-found-label').textContent = strings.filesFoundLabel;
            
            // Hanya perbarui placeholder jika daftar file kosong
            // Periksa apakah placeholder masih menampilkan pesan loading/error gdrive
            if (fileListPlaceholderEl && fileListPlaceholderEl.dataset.gdriveStatus) {
                // Jika masih loading/error, update teks placeholder sesuai bahasa
                const status = fileListPlaceholderEl.dataset.gdriveStatus;
                if (status === 'loading') {
                    fileListPlaceholderEl.textContent = strings.gdriveLoading;
                } else if (status === 'empty') {
                    fileListPlaceholderEl.textContent = strings.gdriveNoFiles;
                }
                // Jika error, biarkan pesan error asli
            } else if (loadedFileObjects.size === 0) {
                 fileListPlaceholderEl.textContent = strings.fileListPlaceholder;
            }


            // 3. Main Content / Header
            document.getElementById('main-header-title').textContent = lang === 'id' ? "LALITA Interactive Catalog" : "LALITA Interactive Catalog"; // Judul ini tetap EN
            document.getElementById('main-header-subtitle').textContent = lang === 'id' ? "Library of Archaeological Legacies and Iconographic Treasures of Ancient Java" : "Library of Archaeological Legacies and Iconographic Treasures of Ancient Java";

            // 4. Dropdown Options
            document.getElementById('view-mode-label').textContent = strings.viewModeLabel;
            document.getElementById('opt-detail').textContent = strings.optDetail;
            document.getElementById('opt-shaded').textContent = strings.optShaded;
            document.getElementById('opt-original').textContent = strings.optOriginal;

            document.getElementById('mesh-view-label').textContent = strings.meshViewLabel;
            document.getElementById('opt-solid').textContent = strings.optSolid;
            document.getElementById('opt-wireframe').textContent = strings.optWireframe;

            // 5. Details Section
            document.getElementById('detail-header').textContent = strings.detailHeader;
            
            // 6. Update Description Box (if no object is loaded)
            if (!loadedObject) {
                descriptionEl.textContent = strings.descPlaceholder;
            } else {
                // Jika objek sudah dimuat, panggil updateDescription untuk meregenerasi teks
                updateDescription(loadedObject, loadedObject.name, loadedObject.descriptionText, null, loadedObject.textureDataURL);
            }
            
            // 7. Re-render file list indicators
            if (loadedFileObjects.size > 0) {
                renderFileList();
            }
        }


        async function init() {
            // Set initial language
            updateUI(languageSelect.value);

            // --- Scene ---
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x374151); // Gray-700 for canvas background

            // --- Camera ---
            camera = new THREE.PerspectiveCamera(75, 2, 0.1, 1000); 
            camera.position.set(10, 10, 10);

            // --- Renderer ---
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            canvasContainer.appendChild(renderer.domElement);
            onWindowResize(); 

            // --- Controls ---
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; 
            controls.dampingFactor = 0.05;

            // --- Lighting ---
            ambientLight = new THREE.AmbientLight(0xffffff, 0.9); // Brighter ambient light
            scene.add(ambientLight);

            directionalLight = new THREE.DirectionalLight(0xffffff, 1.2); // Stronger directional light
            directionalLight.position.set(10, 15, 10);
            directionalLight.visible = false; 
            scene.add(directionalLight);

            // --- Helpers ---
            const gridHelper = new THREE.GridHelper(100, 100, 0x4b5563, 0x374151); // Darker grid
            scene.add(gridHelper);

            // --- Event Listeners ---
            window.addEventListener('resize', onWindowResize);
            
            // Listener untuk tombol bahasa
            languageSelect.addEventListener('change', (e) => updateUI(e.target.value));

            // Listener untuk daftar file (sekarang dari Google Drive)
            fileListEl.addEventListener('click', (event) => {
                const button = event.target.closest('.file-item-button');
                const fileKey = button?.dataset.fileKey; 
            
                if (!fileKey) return; 
                
                const filePairToLoad = loadedFileObjects.get(fileKey); 
                
                if (filePairToLoad && filePairToLoad.objFile) {
                    // Nonaktifkan tombol lain saat memuat
                    document.querySelectorAll('.file-item-button').forEach(btn => btn.disabled = true);
                    
                    // Muat model dan deskripsi dari URL Google Drive
                    loadObjectAndDescription(filePairToLoad.objFile, filePairToLoad.txtFile, filePairToLoad.mtlFile, filePairToLoad.texFile) // Pass texFile
                        .catch(err => {
                            const strings = UI_STRINGS[currentLang];
                            console.error(strings.errorLoadObj(filePairToLoad.objFile.name), err);
                            // Tampilkan error fetch jika ada
                            const errorMsg = err.message.includes('fetch') ? err.message : strings.errorLoadObj(filePairToLoad.objFile.name);
                            updateDescription(null, null, null, errorMsg);
                        })
                        .finally(() => {
                            document.querySelectorAll('.file-item-button').forEach(btn => btn.disabled = false);
                        });
                }
            });

            // Listener untuk opsi tampilan (Dropdowns)
            document.getElementById('view-mode-select').addEventListener('change', updateObjectMaterial);
            document.getElementById('wireframe-select').addEventListener('change', updateObjectMaterial);


            // --- Start Animation Loop ---
            animate();

            // --- Mulai memuat file dari Google Drive ---
            if (!API_KEY || API_KEY === 'YOUR_API_KEY_HERE') {
                console.error("API_KEY tidak diatur. Silakan edit file HTML dan atur API_KEY.");
                fileListPlaceholderEl.textContent = "Error: API_KEY tidak diatur.";
                fileListPlaceholderEl.classList.add("text-red-500");
                fileListPlaceholderEl.dataset.gdriveStatus = 'error';
                return;
            }
            loadGoogleDriveFiles();
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update(); 
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            // Pastikan container punya ukuran sebelum menghitung rasio
            const width = canvasContainer.clientWidth;
            const height = canvasContainer.clientHeight;
            
            if (width === 0 || height === 0) return;
            
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }

        /**
         * Menampilkan pesan status sementara di bawah dropdown.
         * @param {string} message Pesan yang akan ditampilkan.
         * @param {'info'|'warn'} type Tipe pesan (mempengaruhi warna).
         * @param {number} duration Durasi tampil (ms).
         */
        function displayStatusMessage(message, type = 'info', duration = 3000) {
            // Clear previous timeout if any
            if (window.statusTimeout) clearTimeout(window.statusTimeout);

            viewStatusMessageEl.textContent = message;
            // Reset kelas untuk mempertahankan tinggi
            viewStatusMessageEl.className = 'text-sm text-center mb-4 h-5 font-semibold transition-all duration-300'; 

            if (type === 'warn') {
                viewStatusMessageEl.classList.add('text-orange-400');
            } else {
                viewStatusMessageEl.classList.add('text-teal-400');
            }

            // Clear the message after 'duration'
            window.statusTimeout = setTimeout(() => {
                viewStatusMessageEl.textContent = '';
                viewStatusMessageEl.className = 'text-sm text-center mb-4 h-5 font-semibold transition-all duration-300'; // Reset to maintain height
            }, duration);
        }

        // --- Fungsi: Memuat file dari Google Drive ---
        async function loadGoogleDriveFiles() {
            const strings = UI_STRINGS[currentLang];
            fileListPlaceholderEl.textContent = strings.gdriveLoading;
            fileListPlaceholderEl.dataset.gdriveStatus = 'loading';

            try {
                // 1. Load GAPI client
                await new Promise((resolve, reject) => gapi.load('client', { callback: resolve, onerror: reject }));

                // 2. Initialize GAPI client
                await gapi.client.init({
                    'apiKey': API_KEY,
                    'discoveryDocs': ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
                });

                // 3. List files from the folder
                const response = await gapi.client.drive.files.list({
                    q: `'${FOLDER_ID}' in parents and trashed=false`,
                    // Minta webContentLink untuk mengunduh file
                    fields: 'files(id, name, webContentLink, fileExtension)',
                    pageSize: 500 // Asumsi file di bawah 500
                });

                const files = response.result.files;
                if (!files || files.length === 0) {
                    fileListPlaceholderEl.textContent = strings.gdriveNoFiles;
                    fileListPlaceholderEl.dataset.gdriveStatus = 'empty';
                    return;
                }

                // 4. Proses dan pasangkan file (OBJ, TXT, MTL, Tekstur)
                const fileMap = new Map(); // Peta: nama file -> objek file GDrive
                files.forEach(file => {
                    fileMap.set(file.name, file);
                });

                loadedFileObjects.clear(); // Bersihkan map global

                fileMap.forEach((file) => {
                    if (file.fileExtension && file.fileExtension.toLowerCase() === 'obj') {
                        const baseName = file.name.slice(0, -4); // Hapus .obj
                        
                        const txtFile = fileMap.get(baseName + '.txt') || null;
                        const mtlFile = fileMap.get(baseName + '.mtl') || null;
                        const texFile = fileMap.get(baseName + '.jpg') || fileMap.get(baseName + '.png') || null;

                        loadedFileObjects.set(file.name, {
                            objFile: file, // {id, name, webContentLink, ...}
                            txtFile: txtFile,
                            mtlFile: mtlFile,
                            texFile: texFile
                        });
                    }
                });

                // 5. Render daftar file ke sidebar
                if (loadedFileObjects.size === 0) {
                     fileListPlaceholderEl.textContent = strings.gdriveNoFiles;
                     fileListPlaceholderEl.dataset.gdriveStatus = 'empty';
                } else {
                    renderFileList();
                }

            } catch (err) {
                console.error("Gagal memuat file Google Drive:", err);
                const errorResult = err.result || { error: { message: err.message } };
                fileListPlaceholderEl.textContent = strings.gdriveError(errorResult.error);
                fileListPlaceholderEl.classList.add("text-red-500");
                fileListPlaceholderEl.dataset.gdriveStatus = 'error';
            }
        }


        // --- Fungsi: Merender Daftar File ke Sidebar ---
        // (Sebelumnya handleFolderSelection)
        function renderFileList() {
            const strings = UI_STRINGS[currentLang];

            fileListEl.innerHTML = ''; // Bersihkan list
            
            // Hapus placeholder jika ada
            if (fileListPlaceholderEl) {
                fileListPlaceholderEl.remove();
                // Setel ulang referensi agar tidak error jika updateUI dipanggil lagi
                // fileListPlaceholderEl = null; 
                // Biarkan saja, updateUI akan menangani
            }

            const objKeys = Array.from(loadedFileObjects.keys()).sort((a, b) => a.localeCompare(b));

            objKeys.forEach(key => {
                const li = document.createElement('li');
                const button = document.createElement('button');
                button.className = "file-item-button w-full text-left p-3 rounded-lg bg-gray-800 hover:bg-teal-700 transition-colors duration-200 text-sm font-medium disabled:opacity-50 shadow-md";
                button.dataset.fileKey = key; 
                
                const filePair = loadedFileObjects.get(key);
                let indicator = '';
                
                // Indikator menggunakan string bahasa saat ini
                if (!filePair.txtFile) {
                    indicator += ` <span class="text-orange-400 text-xs font-bold">${strings.indicatorNoTxt}</span>`;
                }
                if (!filePair.mtlFile) {
                    indicator += ` <span class="text-sky-400 text-xs font-bold">${strings.indicatorNoMtl}</span>`;
                }
                if (!filePair.texFile) {
                    indicator += ` <span class="text-yellow-400 text-xs font-bold">${strings.indicatorNoTex}</span>`;
                }

                button.innerHTML = key + indicator;
                li.appendChild(button);
                fileListEl.appendChild(li);
            });
        }
        
        // --- Fungsi: Memuat Model OBJ dan File TXT/MTL/Tekstur dari URL ---
        // Versi ini menggunakan fetch() untuk mengambil data dari webContentLink GDrive
        async function loadObjectAndDescription(objFile, txtFile = null, mtlFile = null, texFile = null) {
            // Clear status message
            displayStatusMessage('', 'info', 0);
            const strings = UI_STRINGS[currentLang];
            
            // 1. Ambil OBJ File
            updateDescription(null, null, null, strings.loading(objFile.name));
            let objContent;
            try {
                // PERBAIKAN: Gunakan file ID dan alt=media untuk download langsung
                const objUrl = `https://www.googleapis.com/drive/v3/files/${objFile.id}?alt=media&key=${API_KEY}`;
                const response = await fetch(objUrl);
                if (!response.ok) {
                    throw new Error(strings.errorFetch(objFile.name, response.status));
                }
                objContent = await response.text();
            } catch (e) {
                console.error(e);
                updateDescription(null, null, null, e.message);
                return; // Berhenti jika OBJ gagal dimuat
            }

            // 2. Ambil TXT File (Jika ada)
            let txtContent = null;
            if (txtFile) {
                try {
                    updateDescription(null, null, null, strings.loadingText(objFile.name));
                    // PERBAIKAN: Gunakan file ID dan alt=media untuk download langsung
                    const txtUrl = `https://www.googleapis.com/drive/v3/files/${txtFile.id}?alt=media&key=${API_KEY}`;
                    const response = await fetch(txtUrl);
                    if (!response.ok) throw new Error(); // Gagal diam-diam
                    txtContent = await response.text();
                } catch (error) {
                    console.warn(`Could not fetch companion TXT file: ${txtFile.name}`);
                    txtContent = strings.errorReadTxt(txtFile.name);
                }
            }

            // 3. Ambil MTL File (Jika ada)
            let loadedMtlMaterials = null;
            if (mtlFile) {
                updateDescription(null, null, null, strings.loadingMtl(objFile.name));
                try {
                    // PERBAIKAN: Gunakan file ID dan alt=media untuk download langsung
                    const mtlUrl = `https://www.googleapis.com/drive/v3/files/${mtlFile.id}?alt=media&key=${API_KEY}`;
                    const response = await fetch(mtlUrl);
                    if (!response.ok) throw new Error(strings.errorFetch(mtlFile.name, response.status));
                    const mtlContent = await response.text();

                    // Parse MTL content
                    const mtlLoader = new MTLLoader();
                    loadedMtlMaterials = mtlLoader.parse(mtlContent);
                    loadedMtlMaterials.preload();

                } catch (error) {
                    console.error(`Gagal mengambil atau parse MTL file: ${mtlFile.name}`, error);
                }
            }

            // 4. Ambil Tekstur File (Jika ada)
            let textureDataURL = null; // Ini akan menjadi Blob URL
            if (texFile) {
                updateDescription(null, null, null, strings.loadingTexture(texFile.name));
                try {
                    // PERBAIKAN: Gunakan file ID dan alt=media untuk download langsung
                    const texUrl = `https://www.googleapis.com/drive/v3/files/${texFile.id}?alt=media&key=${API_KEY}`;
                    const response = await fetch(texUrl);
                    if (!response.ok) throw new Error(strings.errorFetch(texFile.name, response.status));
                    
                    const textureBlob = await response.blob();
                    // Buat Blob URL agar TextureLoader bisa membacanya
                    textureDataURL = URL.createObjectURL(textureBlob);

                } catch (error) {
                    console.error(`Gagal mengambil atau parse Texture file: ${texFile.name}`, error);
                }
            }
            
            // 5. Parse OBJ dan Update Deskripsi (Pass materials dan texture)
            parseObj(objContent, objFile.name, txtContent, loadedMtlMaterials, textureDataURL);
        }


        function parseObj(text, fileName, descriptionText = null, materials = null, textureDataURL = null) {
            const strings = UI_STRINGS[currentLang];
            try {
                // Hapus objek yang dimuat sebelumnya (jika ada)
                if (loadedObject) {
                    // Jika objek sebelumnya menggunakan Blob URL, hapus
                    if (loadedObject.textureDataURL && loadedObject.textureDataURL.startsWith('blob:')) {
                        URL.revokeObjectURL(loadedObject.textureDataURL);
                    }
                    scene.remove(loadedObject);
                }

                const loader = new OBJLoader();
                
                // Reset material global
                originalMaterials = materials; 
                customTexture = null;
                customTexturedMaterial = null;

                // Buat material tekstur kustom jika data URL (Blob URL) ada
                if (textureDataURL) {
                    try {
                        // TextureLoader dapat menangani Blob URL
                        const texture = new THREE.TextureLoader().load(textureDataURL);
                        texture.colorSpace = THREE.SRGBColorSpace; // Warna yang benar
                        texture.wrapS = THREE.RepeatWrapping;
                        texture.wrapT = THREE.RepeatWrapping;
                        customTexture = texture; // Simpan
                        
                        customTexturedMaterial = new THREE.MeshPhongMaterial({ 
                            map: customTexture,
                            color: 0xffffff // Putih, biarkan tekstur dominan
                        });
                    } catch (e) {
                        console.error("Gagal membuat material tekstur:", e);
                        // Jika gagal, hapus Blob URL
                        URL.revokeObjectURL(textureDataURL);
                        textureDataURL = null; // Hapus data jika gagal
                    }
                }

                if (materials && !customTexturedMaterial) { // Hanya gunakan MTL jika tidak ada tekstur kustom
                    loader.setMaterials(materials); 
                }
                
                loadedObject = loader.parse(text);
                
                // Tambahkan metadata bahasa ke objek yang dimuat
                loadedObject.name = fileName; 
                loadedObject.descriptionText = descriptionText;
                // Simpan Blob URL agar bisa di-revoke nanti
                loadedObject.textureDataURL = textureDataURL; 

                // --- Center and Scale the Object ---
                const box = new THREE.Box3().setFromObject(loadedObject);
                const size = box.getSize(new THREE.Vector3());
                const center = box.getCenter(new THREE.Vector3());

                // Reposition object to be centered at origin
                loadedObject.position.x += -center.x;
                loadedObject.position.y += -center.y;
                loadedObject.position.z += -center.z;
                
                // Scale object to fit nicely
                const maxSize = Math.max(size.x, size.y, size.z);
                const fitHeight = 15; // Target size in scene units
                const scale = fitHeight / maxSize;
                
                loadedObject.scale.set(scale, scale, scale);
                
                // --- Add to Scene and Update ---
                scene.add(loadedObject);
                
                // FIX: Simpan material original (Tekstur > MTL > Default)
                loadedObject.traverse((child) => {
                    if (child.isMesh) {
                        if (customTexturedMaterial) {
                            // Prioritas 1: Tekstur Kustom
                            child.originalMaterial = customTexturedMaterial;
                        } else if (materials) {
                            // Prioritas 2: Material MTL
                            child.originalMaterial = child.material; 
                        } else {
                            // Prioritas 3: Fallback ke Shaded
                            child.originalMaterial = shadedMaterial.clone(); 
                        }
                    }
                });
                
                // Terapkan material yang benar berdasarkan UI
                updateObjectMaterial(true); 
                
                // Update deskripsi dengan status tekstur
                updateDescription(loadedObject, fileName, descriptionText, null, textureDataURL);

                // Reset camera controls to look at the new object
                controls.target.copy(center.multiplyScalar(scale)); 
                controls.update();

            } catch (error) {
                console.error(error);
                updateDescription(null, null, null, strings.errorParseObj, null);
            }
        }

        // --- Fungsi: Update Material Objek ---
        function updateObjectMaterial(forceStatusUpdate = false) {
            const strings = UI_STRINGS[currentLang];
            
            if (!loadedObject) {
                 // Jangan tampilkan pesan jika hanya ganti bahasa (bukan interaksi user)
                 if (forceStatusUpdate) {
                    displayStatusMessage(strings.noModelLoaded, 'info', 2000);
                 }
                 return;
            }

            // Get current state from the UI using dropdown values
            const viewModeSelect = document.getElementById('view-mode-select');
            const baseStyle = viewModeSelect.value;
            const wireframeStyle = document.getElementById('wireframe-select').value;
            
            isWireframe = wireframeStyle === 'wireframe';

            let targetMaterial = null;

            if (baseStyle === 'detail') {
                targetMaterial = normalMaterial;
                directionalLight.visible = false;
                if (forceStatusUpdate) displayStatusMessage(strings.detailModeApplied, 'info', 2000);
            
            } else if (baseStyle === 'shaded') {
                targetMaterial = shadedMaterial;
                directionalLight.visible = true;
                if (forceStatusUpdate) displayStatusMessage(strings.shadedModeApplied, 'info', 2000);
            
            } else if (baseStyle === 'original') {
                directionalLight.visible = true; // Selalu nyalakan lampu untuk mode original
                
                if (customTexturedMaterial) {
                    if (forceStatusUpdate) displayStatusMessage(strings.originalTextureApplied, 'info');
                } else if (originalMaterials) {
                    if (forceStatusUpdate) displayStatusMessage(strings.originalMtlApplied, 'info');
                } else {
                    // Fallback jika tidak ada MTL atau Tekstur
                    console.warn("Cannot use Original mode: No MTL or Texture file loaded. Falling back to Shaded mode.");
                    viewModeSelect.value = 'shaded'; // Set UI
                    targetMaterial = shadedMaterial; // Set material
                    // Hanya tampilkan pesan peringatan jika ini adalah interaksi user, bukan auto-fallback
                    if (forceStatusUpdate) {
                        displayStatusMessage(strings.warningNoMtlTex, 'warn');
                    }
                }
            }
            
            // Terapkan material baru ke objek yang dimuat
            loadedObject.traverse((child) => {
                if (child.isMesh) {
                    if (baseStyle === 'original' && (customTexturedMaterial || originalMaterials)) {
                        
                        // Kembalikan material original (Tekstur atau MTL)
                        child.material = child.originalMaterial; 
                        
                        // Terapkan wireframe dan needsUpdate pada material original
                        const materialsToUpdate = Array.isArray(child.material) ? child.material : [child.material];
                        
                        materialsToUpdate.forEach(m => {
                            if (m) { // Pastikan material ada
                                m.wireframe = isWireframe;
                                m.needsUpdate = true; 
                            }
                        });
                        
                    } else if (targetMaterial) {
                        // Terapkan material fallback (Normal atau Shaded)
                        child.material = targetMaterial;
                        
                        // Terapkan wireframe dan needsUpdate
                        targetMaterial.wireframe = isWireframe;
                        targetMaterial.needsUpdate = true;
                    }
                }
            });
        }

        function updateDescription(object, fileName, descriptionText = null, message = '', textureDataURL = null) {
            const strings = UI_STRINGS[currentLang];
            
            // Jika ada pesan darurat (error/loading), tampilkan dan keluar
            if (message) {
                descriptionEl.textContent = message;
                return;
            }

            if (!object) {
                descriptionEl.textContent = strings.descPlaceholder;
                return;
            }

            let vertexCount = 0;
            let faceCount = 0;
            let meshCount = 0;

            object.traverse((child) => {
                if (child.isMesh) {
                    meshCount++;
                    const geo = child.geometry;
                    if (geo) {
                        if (geo.attributes.position) {
                            vertexCount += geo.attributes.position.count;
                        }
                        if (geo.index) {
                            faceCount += geo.index.count / 3;
                        } else if (geo.attributes.position) {
                            faceCount += geo.attributes.position.count / 3;
                        }
                    }
                }
            });

            // Status MTL dan Tekstur ditambahkan ke deskripsi
            // 'originalMaterials' dan 'textureDataURL' (dari loadedObject) adalah sumber data yang benar
            const mtlStatus = originalMaterials ? strings.statusYesMtl : strings.statusNoMtl;
            // 'textureDataURL' sekarang adalah Blob URL, tapi kita hanya perlu cek keberadaannya
            const texStatus = textureDataURL ? strings.statusYesTex : strings.statusNoTex;


            let stats = `
${strings.fieldName}:       ${fileName}
${strings.fieldMeshes}:          ${meshCount}
${strings.fieldVertices}:  ${vertexCount.toLocaleString()}
${strings.fieldTriangles}: ${Math.round(faceCount).toLocaleString()}
${strings.fieldMtlLoaded}: ${mtlStatus}
${strings.fieldTexLoaded}:  ${texStatus}
---
`;
            
            // Tambahkan deskripsi dari file TXT jika ada
            if (descriptionText) {
                stats += `\n${descriptionText}\n`;
            }

            descriptionEl.textContent = stats.trim();
        }

        // --- Start the app ---
        window.onload = init;
    </script>

</body>
</html>
